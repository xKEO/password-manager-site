<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Password Manager — Premium Subscription</title>
  <meta name="description" content="Local encrypted vault with Premium subscription access." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-primary:#08080a; --bg-secondary:#0f0f12; --bg-elevated:#161619; --bg-card:rgba(255,255,255,0.02);
      --text-primary:#f4f4f5; --text-secondary:#a1a1aa; --text-muted:#71717a;
      --accent:#f97316; --accent-glow:rgba(249,115,22,0.15); --accent-hover:#fb923c;
      --border:rgba(255,255,255,0.08); --border-strong:rgba(255,255,255,0.12);
      --success:#22c55e; --error:#ef4444;
      --font-display:'Outfit',sans-serif; --font-mono:'JetBrains Mono',monospace;
      --radius-sm:6px; --radius-md:10px; --radius-lg:16px; --radius-xl:24px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      font-family:var(--font-display);
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.6;
      min-height:100vh;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity:0.03;
      pointer-events:none;
      z-index:1000;
    }

    /* HEADER */
    .header{
      position:fixed; top:0; left:0; right:0; z-index:100;
      padding:16px 24px;
      background:rgba(8,8,10,0.8);
      backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:16px;
    }
    .logo{
      display:flex; align-items:center; gap:10px;
      text-decoration:none; color:var(--text-primary);
      min-width:220px;
    }
    .logo-icon{
      width:32px; height:32px;
      background:linear-gradient(135deg,var(--accent),#fb923c);
      border-radius:var(--radius-sm);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
    }
    .logo-icon svg{width:18px;height:18px;color:#000}
    .logo-text{font-weight:600;font-size:18px;letter-spacing:-0.02em}

    .nav-links{
      display:flex; align-items:center; gap:8px;
      flex-wrap:wrap; justify-content:center;
    }
    .nav-link{
      padding:8px 16px;
      color:var(--text-secondary);
      text-decoration:none;
      font-size:14px; font-weight:500;
      border-radius:var(--radius-sm);
      transition:all .15s ease;
    }
    .nav-link:hover{color:var(--text-primary); background:rgba(255,255,255,0.05)}

    .header-actions{
      display:flex; align-items:center; gap:12px;
      min-width:340px;
      justify-content:flex-end;
    }

    /* BUTTONS */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 20px;
      font-family:var(--font-display);
      font-size:14px; font-weight:500;
      border-radius:var(--radius-md);
      border:none;
      cursor:pointer;
      transition:all .15s ease;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .btn-ghost{background:transparent;color:var(--text-secondary);border:1px solid transparent}
    .btn-ghost:hover{color:var(--text-primary);background:rgba(255,255,255,0.05)}
    .btn-outline{background:transparent;color:var(--text-primary);border:1px solid var(--border-strong)}
    .btn-outline:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.2)}
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),#ea580c);
      color:#000; font-weight:800;
      box-shadow:0 0 20px var(--accent-glow);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 24px var(--accent-glow)}
    .btn-lg{padding:14px 28px;font-size:15px}

    /* HERO */
    .hero{
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:120px 24px 80px;
      position:relative;
    }
    .hero::before{
      content:'';
      position:absolute; top:10%; left:50%;
      transform:translateX(-50%);
      width:800px; height:500px;
      background:radial-gradient(ellipse at center,var(--accent-glow),transparent 60%);
      pointer-events:none;
    }
    .hero-content{
      max-width:1200px; width:100%;
      display:grid;
      grid-template-columns:1.05fr 0.95fr;
      gap:60px;
      align-items:center;
      position:relative; z-index:1;
    }
    .hero-text{display:flex;flex-direction:column;gap:24px}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 14px;
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px; font-weight:700;
      color:var(--text-secondary);
      width:fit-content;
    }
    .badge-dot{
      width:6px;height:6px;border-radius:50%;
      background:var(--success);
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .hero h1{
      font-size:clamp(38px,6vw,62px);
      font-weight:900;
      line-height:1.05;
      letter-spacing:-0.03em;
    }
    .hero h1 .accent{
      background:linear-gradient(135deg,var(--accent),#fbbf24);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .hero-description{
      font-size:18px;
      color:var(--text-secondary);
      max-width:560px;
      line-height:1.7;
    }
    .hero-cta{
      display:flex; flex-wrap:wrap;
      align-items:center;
      gap:14px;
      margin-top:8px;
    }
    .note{
      font-size:13px;
      color:var(--text-muted);
      border-left:2px solid rgba(249,115,22,0.35);
      padding-left:12px;
      margin-top:6px;
      max-width:560px;
    }

    /* PRODUCT */
    .hero-visual{position:relative}
    .product-frame{
      position:relative;
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      overflow:hidden;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.03) inset,
        0 40px 80px -20px rgba(0,0,0,0.5),
        0 0 60px var(--accent-glow);
    }
    .product-header{
      display:flex; align-items:center; gap:8px;
      padding:12px 16px;
      background:var(--bg-elevated);
      border-bottom:1px solid var(--border);
    }
    .window-dot{width:10px;height:10px;border-radius:50%}
    .window-dot:nth-child(1){background:#ef4444}
    .window-dot:nth-child(2){background:#eab308}
    .window-dot:nth-child(3){background:#22c55e}
    .product-title{
      flex:1;
      text-align:center;
      font-size:12px;
      color:var(--text-muted);
      font-family:var(--font-mono);
    }
    .product-content{padding:18px}
    .product-placeholder{
      aspect-ratio:16/10;
      background:linear-gradient(135deg,var(--bg-elevated),var(--bg-primary));
      border-radius:var(--radius-md);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:14px;
      color:var(--text-muted);
      font-size:14px;
      border:1px solid rgba(255,255,255,0.06);
    }
    .product-placeholder svg{width:44px;height:44px;opacity:0.55}

    /* SECTIONS */
    .pricing{
      padding:90px 24px 110px;
      border-top:1px solid var(--border);
    }
    .pricing-inner{max-width:1000px;margin:0 auto}
    .section-label{
      font-family:var(--font-mono);
      font-size:12px;
      font-weight:700;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:0.12em;
      margin-bottom:12px;
    }
    .section-title{
      font-size:clamp(28px,4vw,40px);
      font-weight:900;
      letter-spacing:-0.02em;
      margin-bottom:34px;
    }
    .pricing-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:18px;
    }
    .plan{
      padding:26px;
      background:var(--bg-card);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      transition:all 0.2s ease;
      position:relative;
      overflow:hidden;
    }
    .plan:hover{transform:translateY(-2px); border-color:var(--border-strong); background:rgba(255,255,255,0.03)}
    .plan h3{font-size:16px;font-weight:800;margin-bottom:8px}
    .plan p{color:var(--text-secondary);font-size:14px;margin-bottom:16px}
    .price{
      font-size:34px;
      font-weight:900;
      letter-spacing:-0.02em;
      display:flex;
      align-items:baseline;
      gap:8px;
      margin-bottom:14px;
    }
    .price span{font-size:13px;font-weight:800;color:var(--text-muted)}
    .bullets{list-style:none;display:grid;gap:8px;margin:18px 0 22px}
    .bullets li{color:var(--text-secondary);font-size:14px;display:flex;gap:10px;align-items:flex-start}
    .bullets svg{flex:0 0 auto;margin-top:3px}

    .plan-cta{display:flex;gap:10px;flex-wrap:wrap}
    .plan-cta .btn{width:100%}

    .plan-featured{
      border-color:rgba(249,115,22,0.28);
      box-shadow:0 0 0 1px rgba(249,115,22,0.10) inset, 0 0 40px rgba(249,115,22,0.08);
    }
    .pill{
      position:absolute;
      top:16px; right:16px;
      font-family:var(--font-mono);
      font-size:11px;
      color:#000;
      background:linear-gradient(135deg,var(--accent),#fbbf24);
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }

    /* FOOTER */
    .footer{padding:24px;border-top:1px solid var(--border)}
    .footer-inner{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      font-size:13px;color:var(--text-muted);
      gap:16px;
    }
    .footer-links{display:flex;gap:18px;flex-wrap:wrap}
    .footer-links a{color:var(--text-muted);text-decoration:none;transition:color .15s ease}
    .footer-links a:hover{color:var(--text-primary)}

    /* MODALS */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.8);
      backdrop-filter:blur(8px);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
      z-index:200;
      opacity:0; visibility:hidden;
      transition:all 0.2s ease;
    }
    .modal-overlay.active{opacity:1;visibility:visible}
    .modal{
      width:100%; max-width:420px;
      background:var(--bg-secondary);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      padding:30px;
      transform:translateY(20px) scale(0.95);
      transition:all 0.2s ease;
      position:relative;
    }
    .modal-overlay.active .modal{transform:translateY(0) scale(1)}
    .modal-header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:18px;
    }
    .modal-header h2{font-size:20px;font-weight:900}
    .modal-close{
      width:34px;height:34px;
      display:flex;align-items:center;justify-content:center;
      background:transparent;border:none;cursor:pointer;
      color:var(--text-muted);
      border-radius:var(--radius-sm);
      transition:all .15s ease;
    }
    .modal-close:hover{background:rgba(255,255,255,0.05);color:var(--text-primary)}
    .modal-close svg{width:18px;height:18px}

    .form-group{margin-bottom:14px}
    .form-label{
      display:block;
      font-size:13px;
      font-weight:800;
      color:var(--text-secondary);
      margin-bottom:6px;
    }
    .form-input{
      width:100%;
      padding:12px 14px;
      background:var(--bg-primary);
      border:1px solid var(--border);
      border-radius:var(--radius-md);
      color:var(--text-primary);
      font-family:var(--font-display);
      font-size:14px;
      transition:all .15s ease;
    }
    .form-input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-glow);
    }
    .form-input::placeholder{color:var(--text-muted)}
    .form-error{
      padding:12px 14px;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.2);
      border-radius:var(--radius-md);
      color:var(--error);
      font-size:13px;
      margin-bottom:14px;
      display:none;
    }
    .form-error.visible{display:block}
    .form-footer{margin-top:16px}
    .form-footer .btn{width:100%}
    .form-switch{
      margin-top:14px;
      text-align:center;
      font-size:14px;
      color:var(--text-muted);
    }
    .form-switch a{color:var(--accent);text-decoration:none;font-weight:900}
    .form-switch a:hover{text-decoration:underline}

    /* USER MENU */
    .user-menu{display:none;align-items:center;gap:10px}
    .user-menu.active{display:flex}
    .user-avatar{
      width:32px;height:32px;
      background:linear-gradient(135deg,var(--accent),#ea580c);
      border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      font-size:13px;font-weight:900;color:#000;
    }
    .user-name{font-size:14px;font-weight:900;color:var(--text-primary)}
    .guest-actions.hidden{display:none}

    /* RESPONSIVE */
    @media (max-width:900px){
      .nav-links{display:none}
      .hero-content{grid-template-columns:1fr;gap:40px;text-align:center}
      .hero-text{align-items:center}
      .hero-description,.note{max-width:100%}
      .hero-cta{justify-content:center}
      .pricing-grid{grid-template-columns:1fr}
      .header-actions{min-width:unset}
      .logo{min-width:unset}
    }
    @media (max-width:600px){
      .hero{padding:100px 16px 60px}
      .hero-cta{flex-direction:column;width:100%}
      .hero-cta .btn{width:100%}
      .footer-inner{flex-direction:column;text-align:center}
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner">
      <a href="/" class="logo">
        <div class="logo-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
          </svg>
        </div>
        <span class="logo-text">Password Manager</span>
      </a>

      <nav class="nav-links">
        <a href="#pricing" class="nav-link">Pricing</a>
        <a href="#how" class="nav-link">How it works</a>
        <a href="#faq" class="nav-link">FAQ</a>
      </nav>

      <div class="header-actions">
        <!-- Guest actions: shown when logged out -->
        <div class="guest-actions" id="guestActions">
          <button class="btn btn-ghost" onclick="openModal('login')">Log in</button>
          <button class="btn btn-primary" onclick="openModal('signup')">Create account</button>
        </div>

        <!-- User menu: shown when logged in -->
        <div class="user-menu" id="userMenu">
          <button class="btn btn-outline" id="billingBtn" onclick="openModal('billing')">Billing</button>
          <button class="btn btn-primary" id="primaryActionBtn" onclick="handlePrimaryAction()">Subscribe</button>
          <div class="user-avatar" id="userAvatar">U</div>
          <span class="user-name" id="userName">User</span>
          <button class="btn btn-ghost" onclick="logout()">Log out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-content">
      <div class="hero-text">
        <div class="badge">
          <span class="badge-dot"></span>
          Local • Encrypted • Premium Access
        </div>

        <h1>Your vault stays<br><span class="accent">on your machine.</span></h1>

        <p class="hero-description">
          The password manager built for control. Local encrypted vault, premium subscription for updates, downloads, and license access.
        </p>

        <div class="hero-cta">
          <button class="btn btn-outline btn-lg" id="heroPrimaryBtn" onclick="openModal('login')">Log in to subscribe</button>
          <button class="btn btn-primary btn-lg" onclick="openModal('signup')">Create account</button>
        </div>

        <div class="note">
          Guests can browse the landing page freely. Subscriptions unlock downloads and your Premium license.
        </div>
      </div>

      <div class="hero-visual">
        <div class="product-frame">
          <div class="product-header">
            <div class="window-dot"></div>
            <div class="window-dot"></div>
            <div class="window-dot"></div>
            <span class="product-title">vault.lbdb — Password Manager</span>
          </div>
          <div class="product-content">
            <div class="product-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              <span>product.png</span>
            </div>
            <!-- swap in your screenshot later -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PRICING -->
  <section class="pricing" id="pricing">
    <div class="pricing-inner">
      <div class="section-label">Pricing</div>
      <h2 class="section-title">Subscription access. Simple tiers.</h2>

      <div class="pricing-grid">
        <div class="plan">
          <h3>Free</h3>
          <p>Browse the site, create an account, and view product details.</p>

          <div class="price">$0 <span>/ month</span></div>

          <ul class="bullets">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Landing page access
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Account creation
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Billing preview
            </li>
          </ul>

          <div class="plan-cta">
            <button class="btn btn-outline" onclick="openModal('signup')">Create account</button>
          </div>
        </div>

        <div class="plan plan-featured">
          <div class="pill">Premium</div>
          <h3>Premium</h3>
          <p>Subscription unlocks downloads, updates, and your license access.</p>

          <div class="price">$4.99 <span>/ month</span></div>

          <ul class="bullets">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Premium entitlement while active
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Download access (Windows)
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Updates while subscribed
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Priority support
            </li>
          </ul>

          <div class="plan-cta">
            <button class="btn btn-primary" onclick="handleSubscribe()">Subscribe</button>
            <button class="btn btn-outline" onclick="openModal('login')">Already have an account?</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section class="pricing" id="how">
    <div class="pricing-inner">
      <div class="section-label">How it works</div>
      <h2 class="section-title">Guest → Account → Subscription → Download</h2>

      <div class="pricing-grid">
        <div class="plan">
          <h3>1) Guest browsing</h3>
          <p>Anyone can view the landing page. No gate, no friction.</p>
          <ul class="bullets">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Features + pricing visible
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Header shows Log in / Create account
            </li>
          </ul>
        </div>

        <div class="plan">
          <h3>2) Logged in</h3>
          <p>Once logged in, you can access Billing and Subscription.</p>
          <ul class="bullets">
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Header becomes user menu
            </li>
            <li>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              Subscribe / Manage Billing available
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section class="pricing" id="faq">
    <div class="pricing-inner">
      <div class="section-label">FAQ</div>
      <h2 class="section-title">Quick answers</h2>

      <div class="pricing-grid">
        <div class="plan">
          <h3>Does the vault upload to the cloud?</h3>
          <p>No. Your vault stays local. Subscription is for access/licensing/updates.</p>
        </div>

        <div class="plan">
          <h3>What happens if I cancel?</h3>
          <p>Your existing vault stays on your machine. Premium downloads/updates stop until you resubscribe.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <span>© 2025 Password Manager. All rights reserved.</span>
      <div class="footer-links">
        <a href="#">Privacy</a>
        <a href="#">Terms</a>
      </div>
    </div>
  </footer>

  <!-- LOGIN MODAL -->
  <div class="modal-overlay" id="loginModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Log in</h2>
        <button class="modal-close" onclick="closeModal('login')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="form-error" id="loginError"></div>

      <form id="loginForm" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label" for="loginUsername">Username</label>
          <input type="text" id="loginUsername" class="form-input" placeholder="Enter your username" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="loginPassword">Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
        </div>

        <div class="form-footer">
          <button type="submit" class="btn btn-primary">Log in</button>
        </div>

        <div class="form-switch">
          No account? <a href="#" onclick="switchModal('login','signup'); return false;">Create one</a>
        </div>
      </form>
    </div>
  </div>

  <!-- SIGNUP MODAL -->
  <div class="modal-overlay" id="signupModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Create account</h2>
        <button class="modal-close" onclick="closeModal('signup')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="form-error" id="signupError"></div>

      <form id="signupForm" onsubmit="handleSignup(event)">
        <div class="form-group">
          <label class="form-label" for="signupUsername">Username</label>
          <input type="text" id="signupUsername" class="form-input" placeholder="Choose a username" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="signupEmail">Email</label>
          <input type="email" id="signupEmail" class="form-input" placeholder="you@example.com" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="signupPassword">Password</label>
          <input type="password" id="signupPassword" class="form-input" placeholder="Create a password" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="signupPassword2">Confirm Password</label>
          <input type="password" id="signupPassword2" class="form-input" placeholder="Confirm your password" required>
        </div>

        <div class="form-footer">
          <button type="submit" class="btn btn-primary">Create account</button>
        </div>

        <div class="form-switch">
          Already have one? <a href="#" onclick="switchModal('signup','login'); return false;">Log in</a>
        </div>
      </form>
    </div>
  </div>

  <!-- BILLING MODAL -->
  <div class="modal-overlay" id="billingModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Billing</h2>
        <button class="modal-close" onclick="closeModal('billing')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6l12 12"/></svg>
        </button>
      </div>

      <div style="display:grid; gap:12px;">
        <div style="padding:14px;border:1px solid var(--border);border-radius:var(--radius-md);background:rgba(255,255,255,0.02);">
          <div style="font-weight:900;margin-bottom:6px;">Premium status</div>
          <div id="billingStatus" style="color:var(--text-secondary);font-size:14px;">Loading…</div>
        </div>

        <button class="btn btn-primary" id="billingManageBtn" onclick="handleSubscribe()">Subscribe / Manage</button>
        <button class="btn btn-outline" onclick="closeModal('billing')">Close</button>

        <div style="font-size:12px;color:var(--text-muted);">
          Note: “Manage” should become Stripe Customer Portal later.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = 'https://api.passwordmanager.tech';
    const SESSION_KEY = 'pm_web_session_v1';

    // ===== STATE =====
    // currentUser: { uid, username, email, has_purchased, premium, access_token, ... }
    let currentUser = null;
    let accessToken = null;

    // ---------- storage ----------
    function loadSession() {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveSession() {
      if (!currentUser) return;
      localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
    }
    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
    }

    // ---------- api wrapper ----------
    async function apiFetch(path, opts = {}, { retryOn401 = true } = {}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

      const res = await fetch(`${API_BASE}${path}`, {
        ...opts,
        headers,
        credentials: 'include', // REQUIRED for pm_refresh cookie
      });

      if (res.status === 401 && retryOn401) {
        const ok = await tryRefresh();
        if (ok) return apiFetch(path, opts, { retryOn401: false });
      }
      return res;
    }

    async function tryRefresh() {
      try {
        const res = await fetch(`${API_BASE}/api/auth/refresh`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await res.json().catch(() => null);
        if (!res.ok || !data?.success || !data?.access_token) return false;

        accessToken = data.access_token;

        if (currentUser) {
          currentUser.access_token = accessToken;
          // backend still returns has_purchased (legacy). We treat Premium as entitlements truth.
          currentUser.has_purchased = !!data.has_purchased;
          saveSession();
        }
        return true;
      } catch {
        return false;
      }
    }

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const saved = loadSession();
      if (saved?.access_token && saved?.username) {
        currentUser = saved;
        accessToken = saved.access_token;
        updateUIForUser();
      }

      // silent refresh + hydrate user/premium state
      await hydrate();

      // close modal on overlay click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) overlay.classList.remove('active');
        });
      });

      // ESC closes
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
      });

      // show payment result toast (simple)
      const qp = new URLSearchParams(window.location.search);
      const pay = qp.get('payment');
      if (pay === 'success') {
        // after returning from Stripe, refresh entitlements
        await hydrate();
        // optionally remove query param
        // window.history.replaceState({}, document.title, window.location.pathname);
      }
    });

    async function hydrate() {
      if (!accessToken) await tryRefresh();
      if (!accessToken) {
        hardLogoutUIOnly();
        return;
      }

      const ok = await fetchMe();
      if (!ok) {
        hardLogoutUIOnly();
        return;
      }

      await fetchEntitlements(); // THIS is the subscription truth in your backend
      currentUser.access_token = accessToken;
      saveSession();
      updateUIForUser();
    }

    // ---------- ME: matches backend GET /api/user/me ----------
    async function fetchMe() {
      try {
        const res = await apiFetch('/api/user/me', { method: 'GET' });
        const data = await res.json().catch(() => null);
        if (!res.ok || !data?.success) return false;

        const u = data.user || {};
        const p = data.purchase || { has_purchased: false };

        currentUser = {
          uid: u.uid,
          username: u.username,
          email: u.email,
          // legacy field still exists in your backend:
          has_purchased: !!p.has_purchased,
          license_key: p.license_key || null,
          purchased_at: p.purchased_at || null,
          // subscription truth comes from entitlements:
          premium: currentUser?.premium ?? false,
          skus: currentUser?.skus ?? [],
          expires_at: currentUser?.expires_at ?? null,
          access_token: accessToken
        };
        return true;
      } catch {
        return false;
      }
    }

    // ---------- ENTITLEMENTS: matches backend GET /api/pm/entitlements ----------
    async function fetchEntitlements() {
      try {
        const res = await apiFetch('/api/pm/entitlements', { method: 'GET' });
        const data = await res.json().catch(() => null);
        if (!res.ok || !data?.success) return false;

        currentUser.premium = !!data.premium;
        currentUser.skus = data.skus || [];
        currentUser.expires_at = data.expires_at || null;
        return true;
      } catch {
        return false;
      }
    }

    // ===== MODALS =====
    function openModal(type) {
      document.getElementById(`${type}Modal`).classList.add('active');
      if (type === 'billing') renderBilling();
    }
    function closeModal(type) {
      document.getElementById(`${type}Modal`).classList.remove('active');
      const err = document.getElementById(`${type}Error`);
      if (err) { err.classList.remove('visible'); err.textContent = ''; }
    }
    function switchModal(from, to) {
      closeModal(from);
      setTimeout(() => openModal(to), 150);
    }
    function showError(type, message) {
      const el = document.getElementById(`${type}Error`);
      if (!el) return;
      el.textContent = message;
      el.classList.add('visible');
    }

    // ---------- AUTH ----------
    async function handleLogin(e) {
      e.preventDefault();

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data?.success) {
          showError('login', data?.message || 'Login failed');
          return;
        }

        accessToken = data.access_token;

        currentUser = {
          uid: data.uid,
          username: data.username,
          email: data.email,
          has_purchased: !!data.has_purchased, // legacy
          premium: false, // will be hydrated by entitlements
          skus: [],
          expires_at: null,
          access_token: accessToken
        };

        await fetchEntitlements();
        saveSession();

        closeModal('login');
        updateUIForUser();
      } catch (err) {
        showError('login', 'Connection error. Please try again.');
        console.error(err);
      }
    }

    async function handleSignup(e) {
      e.preventDefault();

      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const password2 = document.getElementById('signupPassword2').value;

      if (password !== password2) {
        showError('signup', 'Passwords do not match');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/auth/register`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password, password2 })
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data?.success) {
          showError('signup', data?.message || 'Registration failed');
          return;
        }

        closeModal('signup');
        openModal('login');
      } catch (err) {
        showError('signup', 'Connection error. Please try again.');
        console.error(err);
      }
    }

    async function logout() {
      try {
        await apiFetch('/api/auth/logout', { method: 'POST', body: JSON.stringify({}) }, { retryOn401: false });
      } catch {}
      hardLogoutUIOnly();
    }

    function hardLogoutUIOnly() {
      currentUser = null;
      accessToken = null;
      clearSession();
      updateUIForUser();
    }

    // ---------- SUBSCRIBE (Stripe Checkout) ----------
    // Your backend endpoint is still /api/stripe/create-checkout
    // For monthly subscription, the BACKEND must create Checkout with mode="subscription"
    async function handleSubscribe() {
      if (!currentUser) { openModal('login'); return; }

      // If already premium, treat this as "Manage" later (Stripe Customer Portal).
      // For now, we just tell them they’re active.
      if (currentUser.premium) {
        alert('Premium is active. (Next: wire Billing → Stripe Customer Portal.)');
        return;
      }

      try {
        const res = await apiFetch('/api/stripe/create-checkout', {
          method: 'POST',
          body: JSON.stringify({})
        });

        const data = await res.json().catch(() => null);

        if (!res.ok || !data?.success) {
          alert(data?.message || 'Could not start checkout.');
          return;
        }

        window.location.href = data.checkout_url;
      } catch (e) {
        console.error(e);
        alert('Payment service error.');
      }
    }

    // ---------- DOWNLOAD ----------
    // Your backend download endpoint is /api/download and it enforces purchase right now.
    // Once you update backend to enforce entitlement, this will work for subscriptions.
    async function handleDownload() {
      if (!currentUser) { openModal('login'); return; }
      if (!currentUser.premium) {
        // subscription not active
        window.location.hash = '#pricing';
        alert('Premium subscription required.');
        return;
      }

      try {
        const res = await apiFetch('/api/download', { method: 'GET' });
        const data = await res.json().catch(() => null);

        if (!res.ok || !data?.success) {
          alert(data?.message || 'Download failed.');
          return;
        }

        if (data.license_key) {
          currentUser.license_key = data.license_key;
          saveSession();
          alert(`License key:\n${data.license_key}\n\nDownload will open in a new tab.`);
        }

        window.open(data.download_url, '_blank');
      } catch (e) {
        console.error(e);
        alert('Download error.');
      }
    }

    // ---------- UI ----------
    function updateUIForUser() {
      const guestActions = document.getElementById('guestActions');
      const userMenu = document.getElementById('userMenu');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');

      const primaryActionBtn = document.getElementById('primaryActionBtn');
      const heroPrimaryBtn = document.getElementById('heroPrimaryBtn');

      if (currentUser) {
        guestActions.classList.add('hidden');
        userMenu.classList.add('active');
        userAvatar.textContent = (currentUser.username || 'U').charAt(0).toUpperCase();
        userName.textContent = currentUser.username || 'User';

        // Premium-aware primary CTA
        if (currentUser.premium) {
          primaryActionBtn.textContent = 'Download';
          primaryActionBtn.onclick = handleDownload;

          heroPrimaryBtn.textContent = 'Download (Premium)';
          heroPrimaryBtn.onclick = handleDownload;
          heroPrimaryBtn.classList.remove('btn-outline');
          heroPrimaryBtn.classList.add('btn-primary');
        } else {
          primaryActionBtn.textContent = 'Subscribe';
          primaryActionBtn.onclick = handleSubscribe;

          heroPrimaryBtn.textContent = 'Subscribe';
          heroPrimaryBtn.onclick = handleSubscribe;
          heroPrimaryBtn.classList.remove('btn-primary');
          heroPrimaryBtn.classList.add('btn-outline');
        }
      } else {
        guestActions.classList.remove('hidden');
        userMenu.classList.remove('active');

        // hero button is login when logged out
        heroPrimaryBtn.textContent = 'Log in to subscribe';
        heroPrimaryBtn.onclick = () => openModal('login');
        heroPrimaryBtn.classList.remove('btn-primary');
        heroPrimaryBtn.classList.add('btn-outline');
      }
    }

    function renderBilling() {
      const status = document.getElementById('billingStatus');
      const btn = document.getElementById('billingManageBtn');
      if (!status || !btn) return;

      if (!currentUser) {
        status.textContent = 'Please log in.';
        btn.textContent = 'Log in';
        btn.onclick = () => { closeModal('billing'); openModal('login'); };
        return;
      }

      if (currentUser.premium) {
        let extra = '';
        if (currentUser.expires_at) extra = ` (renews until ${currentUser.expires_at})`;
        status.textContent = 'Active — Premium subscription is enabled.' + extra;
        btn.textContent = 'Manage (coming soon)';
        btn.onclick = () => alert('Next step: Stripe Customer Portal.');
      } else {
        status.textContent = 'Inactive — Subscribe to unlock downloads and updates.';
        btn.textContent = 'Subscribe';
        btn.onclick = handleSubscribe;
      }
    }

    // Header main button uses this
    function handlePrimaryAction() {
      if (!currentUser) { openModal('login'); return; }
      if (currentUser.premium) return handleDownload();
      return handleSubscribe();
    }
  </script>
</body>
</html>
